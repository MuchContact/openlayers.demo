<!DOCTYPE html>
<html>
  <head>
    <title>Draw Features</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">
    <link rel="stylesheet" href="main.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v3.19.1/build/ol.js"></script>
  </head>
  <body>
    <div id="controlPanel" class="controlPanel">
      <input type="button" value="添加点" onclick="drawPoint()"></input>
      <input type="button" value="添加线" onclick="drawLine()"></input>
      <input type="button" value="添加面" onclick="drawPolygon()"></input>
      <input type="button" value="清除" onclick="clearOverlays()"></input>
      <br/>
      <input type="button" value="添加图层" onclick="addLayer()"></input>
      <input type="button" value="删除图层" onclick="deleteLayer()"></input>
      <hr/>
      <textarea id="featureInput" cols="40" rows="20"></textarea><br/>
      <input type="button" value="添加要素" onclick="addFeature()">
      </input>

    </div>
    <div id="map" class="map"></div>

    <script>
      var content = {
        'type':'FeatureCollection',
        'crs':{
          'type':'name',
          'properties':{
            'name':'EPSG:3857'
          }
        },
        'features':[
          {
            'type':'Feature',
            'geometry':{
              'type':'Point',
              'coordinates':[-10e6, 5e6]
            }
          }
        ]
      };
      document.getElementById('featureInput').value=JSON.stringify(content);
      var raster = new ol.layer.Tile({
        source: new ol.source.OSM()
      });

      var source = new ol.source.Vector({wrapX: false});

      var vector = new ol.layer.Vector({
        source: source
      });

      var map = new ol.Map({
        layers: [raster, vector],
        target: 'map',
        view: new ol.View({
          center: [-11000000, 4600000],
          zoom: 4
        })
      });
      // map.getLayers().setAt(10, vector);
      var draw; // global so we can remove it later
      function addInteraction(value) {
        if (value !== 'None') {
          draw = new ol.interaction.Draw({
            source: source,
            type: /** @type {ol.geom.GeometryType} */ (value)
          });
          map.addInteraction(draw);
        }
      }

      function drawGraph(type) {
        if(draw !== undefined)
          map.removeInteraction(draw);
        addInteraction(type);
      }

      function drawPoint() {
        drawGraph("Point");
      }

      function drawLine() {
        drawGraph("LineString");
      }

      function drawPolygon() {
        drawGraph("Polygon");
      }

      function clearOverlays() {
        source.clear();
      }

      var arcgisLayer;
      function addLayer() {
        let url = 'https://sampleserver1.arcgisonline.com/ArcGIS/rest/services/' +
          'Specialty/ESRI_StateCityHighway_USA/MapServer';
        arcgisLayer = new ol.layer.Tile({
          extent: [-13884991, 2870341, -7455066, 6338219],
          source: new ol.source.TileArcGISRest({
            url: url
          })
        });
        map.removeLayer(vector);
        map.addLayer(arcgisLayer);
        map.addLayer(vector);
      }

      function deleteLayer() {
        if(arcgisLayer !== undefined)
          map.removeLayer(arcgisLayer);
      }

      var thing = new ol.geom.Polygon( [[
          ol.proj.transform([-16,-22], 'EPSG:4326', 'EPSG:3857'),
          ol.proj.transform([-44,-55], 'EPSG:4326', 'EPSG:3857'),
          ol.proj.transform([-88,75], 'EPSG:4326', 'EPSG:3857')
      ]]);
      var featurething = new ol.Feature({
          name: "Thing",
          geometry: thing
      });

      var geojsonFeatures;

      function addFeature() {
          let geojsonObject = JSON.parse(document.getElementById('featureInput').value);
          console.log(geojsonObject);
          var vectorSource = new ol.source.Vector({
            features: (new ol.format.GeoJSON()).readFeatures(geojsonObject)
          });
          // geojsonFeatures = (new ol.format.GeoJSON()).readFeatures(geojsonObject);
          // source.addFeature(geojsonFeatures);
          var styleFunction = function(feature, resolution) {
            return styles[feature.getGeometry().getType()];
          };
          var vectorLayer1 = new ol.layer.Vector({
            source: vectorSource
          });
          map.addLayer(vectorLayer1);
      }
    </script>
  </body>
</html>
